<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <title>Valle de Valdelaguna</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet 2 (CSS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.css">

  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    .locate-btn {
      background: #fff;
      width: 34px;
      height: 34px;
      cursor: pointer;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      font-size: 18px;
      line-height: 30px;
      text-align: center;
    }
  </style>

  <!-- Importmap (Leaflet 2 ESM) -->
  <script type="importmap">
    {
      "imports": {
        "leaflet": "https://unpkg.com/leaflet@2.0.0-alpha.1/dist/leaflet.js"
      }
    }
  </script>
</head>

<body>
  <div id="map"></div>

  <script type="module">
    import L from 'leaflet';

    // --- Mapa ---
    const map = new L.Map('map').setView([42.10997086796638, -3.149189421895146], 15);

    // --- Capes base ---
    const osm = new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const orto = new L.TileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles Â© Esri' }
    );

    // --- Cadastre (WMS) ---
    // Leaflet 2 mantÃ© la classe TileLayer.WMS (constructor)
    const catastro = new L.TileLayer.WMS('https://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx', {
      layers: 'Catastro',
      format: 'image/png',
      transparent: true,
      attribution: 'Â© DirecciÃ³n General del Catastro'
    });

    // --- GeoJSON per categories (AssignaciÃ³_finques: C, D, CD) ---
    const capaC  = new L.LayerGroup();
    const capaD  = new L.LayerGroup();
    const capaCD = new L.LayerGroup();

    function estil(color) {
      return { color, weight: 2, fillOpacity: 0.5 };
    }

    function popup(feature, layer) {
      if (!feature.properties) return;
      layer.bindPopup(
        Object.entries(feature.properties)
          .map(([k, v]) => `<b>${k}</b>: ${v}`)
          .join('<br>')
      );
    }

    // Carregar GeoJSON (amb â€œcache-bustingâ€)
    fetch('Parc_CD.geojson?v=' + Date.now())
      .then(r => {
        if (!r.ok) throw new Error('No sâ€™ha pogut carregar Parc_CD.geojson');
        return r.json();
      })
      .then(data => {
        new L.GeoJSON(data, {
          filter: f => (f.properties && f.properties.AssignaciÃ³_finques === 'C'),
          style: estil('#2e7d32'),
          onEachFeature: popup
        }).addTo(capaC);

        new L.GeoJSON(data, {
          filter: f => (f.properties && f.properties.AssignaciÃ³_finques === 'D'),
          style: estil('#ef6c00'),
          onEachFeature: popup
        }).addTo(capaD);

        new L.GeoJSON(data, {
          filter: f => (f.properties && f.properties.AssignaciÃ³_finques === 'CD'),
          style: estil('#1565c0'),
          onEachFeature: popup
        }).addTo(capaCD);

        capaC.addTo(map);
        capaD.addTo(map);
        capaCD.addTo(map);
      })
      .catch(err => console.error(err));

    // --- Control de capes (bases + overlays) ---
    const baseMaps = {
      "OpenStreetMap": osm,
      "Ortofoto": orto
    };

    const overlayMaps = {
      "ParcelÂ·les C": capaC,
      "ParcelÂ·les D": capaD,
      "ParcelÂ·les CD": capaCD,
      "Cadastre": catastro
    };

    new L.Control.Layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    // --- GeolocalitzaciÃ³ (punter posiciÃ³ real) ---
    let userMarker = null;
    let userCircle = null;

    function locateUser() {
      map.locate({
        setView: true,
        maxZoom: 18,
        enableHighAccuracy: true,
        watch: false
      });
    }

    map.on('locationfound', (e) => {
      const latlng = e.latlng;
      const acc = e.accuracy;

      if (userMarker) map.removeLayer(userMarker);
      if (userCircle) map.removeLayer(userCircle);

      userMarker = new L.Marker(latlng).addTo(map).bindPopup("La meva posiciÃ³");
      userCircle = new L.Circle(latlng, { radius: acc }).addTo(map);
    });

    map.on('locationerror', () => {
      alert("No s'ha pogut obtenir la ubicaciÃ³. Revisa permisos de localitzaciÃ³ del navegador i el GPS.");
    });

    // BotÃ³ de geolocalitzaciÃ³ (ES6 class, alineat amb Leaflet 2)
    class LocateControl extends L.Control {
      constructor(options = {}) {
        super(options);
      }
      onAdd() {
        const btn = L.DomUtil.create('button', 'locate-btn');
        btn.type = 'button';
        btn.title = "La meva posiciÃ³";
        btn.innerHTML = "ðŸ“";

        L.DomEvent.on(btn, 'click', (ev) => {
          L.DomEvent.stopPropagation(ev);
          L.DomEvent.preventDefault(ev);
          locateUser();
        });

        L.DomEvent.disableClickPropagation(btn);
        return btn;
      }
    }

    map.addControl(new LocateControl({ position: 'topleft' }));
  </script>
</body>
</html>


